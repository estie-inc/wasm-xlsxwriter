name: test

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20.x"
      - run: npm ci
      - run: npm run build
      # Validate that the compiled WASM only contains the expected features.
      # This ensures reference-types and multivalue are NOT included,
      # which would break compatibility with older browsers (Chrome <91, Firefox <78, Safari <15.4).
      # Expected features: bulk-memory, mutable-globals, nontrapping-float-to-int, sign-ext
      - name: Validate WebAssembly features
        run: |
          WASM_OPT=$(find "$HOME/.cache/.wasm-pack" -type f -name "wasm-opt" 2>/dev/null | head -1)
          if [ -z "$WASM_OPT" ]; then
            echo "::error::wasm-opt not found in wasm-pack cache"
            exit 1
          fi
          echo "Using wasm-opt: $WASM_OPT"
          expected="bulk-memory mutable-globals nontrapping-float-to-int sign-ext"
          for target in nodejs web; do
            actual=$($WASM_OPT --print-features $target/wasm_xlsxwriter_bg.wasm 2>&1 | sed -n 's/^--enable-//p' | sort | xargs)
            echo "$target: $actual"
            if [ "$actual" != "$expected" ]; then
              echo "::error::$target has unexpected features: $actual (expected: $expected)"
              exit 1
            fi
          done
      - run: npm test
      - run: |
          cd examples/nextjs
          npm ci
          npm run build
      - run: |
          cd examples/nodejs
          npm ci
          npm run build
          npm run start
